window.bp=window.bp||{},function(l){"undefined"!=typeof BP_Nouveau&&(bp.Nouveau=bp.Nouveau||{},bp.Nouveau.Video={start:function(){this.setupGlobals(),this.addListeners()},setupGlobals:function(){var e=l("body");this.video_dropzone_obj=[],this.dropzone_video=[],this.video_album_id=void 0!==BP_Nouveau.video.album_id&&BP_Nouveau.video.album_id,this.video_group_id=void 0!==BP_Nouveau.video.group_id&&BP_Nouveau.video.group_id,this.current_tab=!e.hasClass("single-topic")&&!e.hasClass("single-forum")&&"bp-video-dropzone-content",void 0!==window.Dropzone&&(window.Dropzone.autoDiscover=!1),this.videoOptions={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.video.dictFileTooBig,acceptedFiles:BP_Nouveau.video.video_type,createImageThumbnails:!1,dictDefaultMessage:BP_Nouveau.video.dropzone_video_message,autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:void 0!==BP_Nouveau.video.maxFiles?BP_Nouveau.video.maxFiles:10,maxFilesize:void 0!==BP_Nouveau.video.max_upload_size?BP_Nouveau.video.max_upload_size:2,dictInvalidFileType:BP_Nouveau.video.dictInvalidFileType},void 0!==BP_Nouveau.video.dropzone_options&&Object.assign(this.options,BP_Nouveau.video.dropzone_options)},addListeners:function(){l(document).on("click","#bp-add-video",this.openUploader.bind(this)),l(document).on("click","#bp-video-submit",this.submitVideo.bind(this))},submitVideo:function(o){var e,i,d,t=this,a=l(o.currentTarget),n=l("#bb-video-privacy");if(o.preventDefault(),a.hasClass("saving"))return!1;a.addClass("saving"),"bp-video-dropzone-content"===t.current_tab?(e=l("#bp-video-post-content").val(),i={action:"video_save",_wpnonce:BP_Nouveau.nonces.video,videos:t.dropzone_video,content:e,album_id:t.video_album_id,group_id:t.video_group_id,privacy:n.val()},l("#bp-video-dropzone-content .bp-feedback").remove(),l.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:i,success:function(e){if(e.success){l("#video-stream ul.video-list").length||(l("#video-stream").html(l("<ul></ul>").addClass("video-list item-list bp-list bb-video-list grid")),l(".bb-videos-actions").show()),bp.Nouveau.inject("#video-stream ul.video-list",e.data.video,"prepend");for(var i=0;i<t.dropzone_video.length;i++)t.dropzone_video[i].saved=!0;t.closeUploader(o),jQuery(window).scroll()}else l("#bp-video-dropzone-content").prepend(e.data.feedback);a.removeClass("saving")}})):"bp-existing-video-content"===t.current_tab?(d=[],l('.bp-existing-video-wrap .bb-video-check-wrap [name="bb-video-select"]:checked').each(function(){d.push(l(this).val())}),i={action:"video_move_to_album",_wpnonce:BP_Nouveau.nonces.video,medias:d,album_id:t.video_album_id,group_id:t.video_group_id},l("#bp-existing-video-content .bp-feedback").remove(),l.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:i,success:function(e){e.success?(l("#video-stream ul.media-list").length||(l("#video-stream").html(l("<ul></ul>").addClass("video-list item-list bp-list bb-video-list grid")),l(".bb-video-actions").show()),bp.Nouveau.inject("#video-stream ul.video-list",e.data.video,"prepend"),l('.bp-existing-video-wrap .bb-video-check-wrap [name="bb-video-select"]:checked').each(function(){l(this).closest("li").data("id")===l(this).val()&&l(this).closest("li").remove()}),jQuery(window).scroll(),t.closeUploader(o)):l("#bp-existing-video-content").prepend(e.data.feedback),a.removeClass("saving")}})):t.current_tab||(t.closeUploader(o),a.removeClass("saving"))},closeUploader:function(e){e.preventDefault(),l("#bp-video-uploader").hide(),l("#bp-video-add-more").hide(),l("#bp-video-uploader-modal-title").text(BP_Nouveau.video.i18n_strings.upload),l("#bp-video-uploader-modal-status-text").text(""),this.video_dropzone_obj.destroy(),this.dropzone_video=[];var i=l(e.currentTarget).closest("#bp-video-uploader");i.find(".bb-field-steps").length&&(i.find(".bb-field-steps-1").show().siblings(".bb-field-steps-2").hide(),i.find("#bp-media-document-prev, #bp-media-document-submit, .bp-document-open-create-popup-folder").hide()),this.clearFolderLocationUI(e)},clearFolderLocationUI:function(e){var i=jQuery(e.currentTarget).closest(".has-folderlocationUI");0<i.length&&(i.find(".location-folder-list-wrap-main .location-folder-list-wrap .location-folder-list li").each(function(){jQuery(this).removeClass("is_active").find("span.selected:not(.disabled)").removeClass("selected"),jQuery(this).find("ul").hide()}),i.find(".location-folder-list-wrap-main .location-folder-list-wrap .location-folder-list li").show().children("span, i").show(),i.find(".location-folder-title").text(BP_Nouveau.media.target_text),i.find(".location-folder-back").hide().closest(".has-folderlocationUI").find(".bb-folder-selected-id").val("0"),i.find(".ac_document_search_folder").val(""),i.find(".bb-model-header h4 span").text("..."),i.find(".ac_document_search_folder_list ul").html("").parent().hide().siblings(".location-folder-list-wrap").find(".location-folder-list").show())},openUploader:function(e){var o=this;e.preventDefault(),void 0!==window.Dropzone&&l("div#video-uploader").length&&(l("#bp-video-uploader").show(),o.video_dropzone_obj=new Dropzone("div#video-uploader",o.videoOptions),o.video_dropzone_obj.on("sending",function(e,i,o){o.append("action","video_upload"),o.append("_wpnonce",BP_Nouveau.nonces.video)}),o.video_dropzone_obj.on("addedfile",function(){setTimeout(function(){o.video_dropzone_obj.getAcceptedFiles().length&&l("#bp-video-uploader-modal-status-text").text(wp.i18n.sprintf(BP_Nouveau.video.i18n_strings.upload_status,o.dropzone_video.length,o.video_dropzone_obj.getAcceptedFiles().length)).show()},1e3)}),o.video_dropzone_obj.on("error",function(e,i){e.accepted?void 0!==i&&void 0!==i.data&&void 0!==i.data.feedback&&l(e.previewElement).find(".dz-error-message span").text(i.data.feedback):this.removeFile(e)}),o.video_dropzone_obj.on("queuecomplete",function(){l("#bp-video-uploader-modal-title").text(BP_Nouveau.video.i18n_strings.upload)}),o.video_dropzone_obj.on("processing",function(){l("#bp-video-uploader-modal-title").text(BP_Nouveau.video.i18n_strings.uploading+"...")}),o.video_dropzone_obj.on("success",function(e,i){i.data.id?(e.id=i.id,i.data.uuid=e.upload.uuid,i.data.menu_order=o.dropzone_video.length,i.data.album_id=o.video_album_id,i.data.group_id=o.video_group_id,i.data.saved=!1,o.dropzone_video.push(i.data)):this.removeFile(e),l("#bp-video-submit").show(),l("#bp-video-uploader-modal-title").text(BP_Nouveau.video.i18n_strings.uploading+"..."),l("#bp-video-uploader-modal-status-text").text(wp.i18n.sprintf(BP_Nouveau.video.i18n_strings.upload_status,o.dropzone_video.length,o.video_dropzone_obj.getAcceptedFiles().length)).show()}),o.video_dropzone_obj.on("removedfile",function(e){if(o.dropzone_video.length)for(var i in o.dropzone_video)if(e.upload.uuid==o.dropzone_video[i].uuid){void 0===o.dropzone_video[i].saved||o.dropzone_video[i].saved||o.removeAttachment(o.dropzone_video[i].id),o.dropzone_video.splice(i,1);break}o.video_dropzone_obj.getAcceptedFiles().length?l("#bp-video-uploader-modal-status-text").text(wp.i18n.sprintf(BP_Nouveau.video.i18n_strings.upload_status,o.dropzone_video.length,o.video_dropzone_obj.getAcceptedFiles().length)).show():(l("#bp-video-uploader-modal-status-text").text(""),l("#bp-video-submit").hide())}))},toggle_video_uploader:function(){this.open_video_uploader()},open_video_uploader:function(){if(this.$el.find("#activity-post-media-uploader").hasClass("open"))return!1}},bp.Views.ActivityVideo=bp.View.extend({tagName:"div",className:"activity-video-container",template:bp.template("activity-video"),video:[],videoDropzoneObj:null,editActivityData:null,initialize:function(){this.model.set("video",this.video),document.addEventListener("activity_video_toggle",this.toggle_video_uploader.bind(this)),document.addEventListener("activity_video_close",this.destroyVideo.bind(this))},toggle_video_uploader:function(){var e=this;_.isUndefined(bp.Views.ActivityVideoData)||(e.editActivityData=bp.Views.ActivityVideoData),e.$el.find("#activity-post-video-uploader").hasClass("open")?e.destroyVideo():(e.open_video_uploader(),e.prepareEditVideoActivity())},destroyVideo:function(){var e=this;_.isNull(e.videoDropzoneObj)||(e.videoDropzoneObj.destroy(),e.$el.find("#activity-post-video-uploader").html("")),e.video=[],e.$el.find("#activity-post-video-uploader").removeClass("open").addClass("closed"),document.removeEventListener("activity_video_toggle",this.toggle_video_uploader.bind(this)),document.removeEventListener("activity_video_close",this.destroyVideo.bind(this)),l("#whats-new-attachments").addClass("empty")},open_video_uploader:function(){var v=this;if(v.$el.find("#activity-post-video-uploader").hasClass("open"))return!1;v.destroyVideo();var e={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:BP_Nouveau.video.dictFileTooBig,acceptedFiles:BP_Nouveau.video.video_type,createImageThumbnails:!1,dictDefaultMessage:BP_Nouveau.video.dropzone_video_message,autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:void 0!==BP_Nouveau.video.maxFiles?BP_Nouveau.video.maxFiles:10,maxFilesize:void 0!==BP_Nouveau.video.max_upload_size?BP_Nouveau.video.max_upload_size:2,dictInvalidFileType:BP_Nouveau.video.dictInvalidFileType};v.videoDropzoneObj=new window.Dropzone("#activity-post-video-uploader",e),v.videoDropzoneObj.on("addedfile",function(e){e.video_edit_data&&(v.video.push(e.video_edit_data),v.model.set("video",v.video))}),v.videoDropzoneObj.on("sending",function(e,i,o){o.append("action","video_upload"),o.append("_wpnonce",BP_Nouveau.nonces.video);var d=v.$el.parents("#whats-new-form");d.find("#activity-media-button")&&d.find("#activity-media-button").parents(".post-elements-buttons-item").addClass("disable"),d.find("#activity-gif-button")&&d.find("#activity-gif-button").parents(".post-elements-buttons-item").addClass("disable"),d.find("#activity-document-button")&&d.find("#activity-document-button").parents(".post-elements-buttons-item").addClass("no-click")}),v.videoDropzoneObj.on("success",function(e,i){if(!i.data.id){var o,d,t,a,n,s=i.data.feedback;for(e.previewElement.classList.add("dz-error"),n=[],d=0,t=(a=e.previewElement.querySelectorAll("[data-dz-errormessage]")).length;d<t;d++)o=a[d],n.push(o.textContent=s);return n}bp.privacyEditable||(i.data.folder_id=bp.folder_id,i.data.group_id=bp.group_id,i.data.privacy=bp.privacy),e.id=i.data.id,i.data.uuid=e.upload.uuid,i.data.group_id=!_.isUndefined(BP_Nouveau.media)&&!_.isUndefined(BP_Nouveau.media.group_id)&&BP_Nouveau.media.group_id,i.data.saved=!1,i.data.menu_order=l(e.previewElement).closest(".dropzone").find(e.previewElement).index()-1,v.video.push(i.data),v.model.set("video",v.video)}),v.videoDropzoneObj.on("accept",function(e,i){0==e.size?i(BP_Nouveau.media.empty_document_type):i()}),v.videoDropzoneObj.on("error",function(e,i){e.accepted?_.isUndefined(i)||_.isUndefined(i.data)||_.isUndefined(i.data.feedback)||l(e.previewElement).find(".dz-error-message span").text(i.data.feedback):(l("body").append('<div id="bp-media-create-folder" style="display: block;" class="open-popup"><transition name="modal"><div class="modal-mask bb-white bbm-model-wrap"><div class="modal-wrapper"><div id="boss-media-create-album-popup" class="modal-container has-folderlocationUI"><header class="bb-model-header"><h4>'+BP_Nouveau.media.invalid_file_type+'</h4><a class="bb-model-close-button" id="bp-media-create-folder-close" href="#"><span class="dashicons dashicons-no-alt"></span></a></header><div class="bb-field-wrap"><p>'+i+"</p></div></div></div></div></transition></div>"),this.removeFile(e))}),v.videoDropzoneObj.on("removedfile",function(e){if(v.video.length)for(var i in v.video)e.id===v.video[i].id&&(_.isUndefined(v.video[i].saved)||v.video[i].saved||bp.Nouveau.Media.removeAttachment(e.id),v.video.splice(i,1),v.model.set("video",v.video));var o;_.isNull(v.videoDropzoneObj.files)||0!==v.videoDropzoneObj.files.length||((o=v.$el.parents("#whats-new-form")).find("#activity-media-button")&&o.find("#activity-media-button").parents(".post-elements-buttons-item").removeClass("disable active no-click"),o.find("#activity-gif-button")&&o.find("#activity-gif-button").parents(".post-elements-buttons-item").removeClass("disable active no-click"),o.find("#activity-document-button")&&o.find("#activity-document-button").parents(".post-elements-buttons-item").removeClass("disable active no-click"))}),v.$el.find("#activity-post-video-uploader").addClass("open").removeClass("closed"),l("#whats-new-attachments").removeClass("empty")},prepareEditVideoActivity:function(){var e=this;if(_.isUndefined(e.editActivityData))return!1;var i=e.editActivityData,o=l("#whats-new-toolbar");o.find("#activity-media-button")&&o.find("#activity-media-button").parents(".post-elements-buttons-item").addClass("no-click"),o.find("#activity-document-button")&&o.find("#activity-document-button").parents(".post-elements-buttons-item").addClass("no-click"),o.find("#activity-video-button")&&o.find("#activity-video-button").parents(".post-elements-buttons-item").addClass("active no-click"),o.find("#activity-gif-button")&&o.find("#activity-gif-button").parents(".post-elements-buttons-item").addClass("no-click");for(var d=!1,t=0;t<i.video.length;t++)d=!1,d={name:i.video[t].title,accepted:!0,kind:"image",upload:{filename:i.video[t].title,uuid:i.video[t].attachment_id},dataURL:i.video[t].placeholder_url,id:i.video[t].attachment_id,video_edit_data:{id:i.video[t].attachment_id,media_id:i.video[t].id,name:i.video[t].name,thumb:i.video[t].placeholder_thumb,url:i.video[t].placeholder_url,uuid:i.video[t].attachment_id,menu_order:i.video[t].menu_order,album_id:i.video[t].album_id,group_id:i.video[t].group_id,saved:!0}},e.videoDropzoneObj&&(e.videoDropzoneObj.files.push(d),e.videoDropzoneObj.emit("addedfile",d),e.createThumbnailFromUrl(d))},createThumbnailFromUrl:function(i){var o=this;o.videoDropzoneObj.createThumbnailFromUrl(i,o.videoDropzoneObj.options.thumbnailWidth,o.videoDropzoneObj.options.thumbnailHeight,o.videoDropzoneObj.options.thumbnailMethod,!0,function(e){o.videoDropzoneObj.emit("thumbnail",i,e),o.videoDropzoneObj.emit("complete",i)})}}),bp.Nouveau.Video.start(),bp.Nouveau.Video.Theatre={start:function(){this.setupGlobals(),this.addListeners()},setupGlobals:function(){this.videos=[],this.current_video=!1,this.current_video_index=0,this.is_open_video=!1,this.nextVideoLink=l(".bb-next-video"),this.previousVideoLink=l(".bb-prev-video"),this.activity_ajax=!1,this.group_id=void 0!==BP_Nouveau.video.group_id&&BP_Nouveau.video.group_id},addListeners:function(){l(document).on("click",".bb-open-media-theatre",this.openTheatre.bind(this))},openTheatre:function(e){e.preventDefault();var i,o=l(e.currentTarget),d=this;if(o.closest("#bp-existing-media-content").length)return!1;d.setupGlobals(),d.setMedias(o),i=o.data("id"),d.setCurrentMedia(i),d.showMedia(),d.navigationCommands(),void 0!==BP_Nouveau.activity&&d.current_media&&void 0!==d.current_media.activity_id&&0!=d.current_media.activity_id&&!d.current_media.is_forum?d.getActivity():d.getMediasDescription(),l(".bb-media-model-wrapper.document").hide(),l(".bb-media-model-wrapper.media").show(),d.is_open_media=!0}},bp.Nouveau.Video.Theatre.start())}((bp,jQuery));